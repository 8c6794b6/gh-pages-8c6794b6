<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Warm Fuzzy Thing - Bytestring and unicode chars from U+0080 to U+00FF</title>
    <link rel="shortcut icon" href="../favicon.ico" type="image/x-icon">
    <link rel="icon" href="favicon.ico" type="image/ico">
    <link rel="stylesheet" type="text/css" href="../css/style.css">
    <link rel="stylesheet" type="text/css" href="../css/hk-tango.css">
    <link rel="alternate" type="application/rss+xml" title="Warm Fuzzy Thing" href="../rss.xml">
  </head>
  <body>
    <div>
      <div id="site_name">
        <div id="site_name_contents">
          <a href="../index.html">Warm Fuzzy Thing</a>
        </div>
      </div>

      <div id="header">
        <div id="header_contents">
          <div id="navigation">
            <a href="../index.html">Home</a>
            <a href="../archive.html">Archive</a>
            <a href="../rss.xml">RSS</a>
          </div>
        </div>
      </div>

      <div id="content">

        <h1>Bytestring and unicode chars from U+0080 to U+00FF</h1>
<div id="post_date">
  <strong>November 2, 2011</strong>
</div>

<div id="post_body">
<p>While I was viewing html files, got an error:</p>
<pre><code>| A web handler threw an exception. Details:
| Cannot decode byte '\xa0': Data.Text.Encoding.Fusion.streamUtf8: Invalid UTF-8 stream
</code></pre>
<p>The html file was served by <a href="http://www.snapframework.com">snap</a>. Somewhere inside in it’s data transfer, something wrong is happening with utf8 decoding with function in <a href="http://http://hackage.haskell.org/packages/archive/text/latest/doc/html/Data-Text.html">Data.Text</a>. The byte failed to decode: <code>'\xa0'</code>, was <a href="http://www.fileformat.info/info/unicode/char/a0/index.htm">no-break space</a>.</p>
<p>No-break space in UTF–8 is <code>0xc2 0xa0</code>, expressed with 2 bytes. When <code>decodeUtf8</code> convert <code>ByteString</code>, it is expecting <code>0xc2</code> prefix to be passed together, but when above error occured, only the latter <code>0xa0</code> has passed. Later I realised that all characters in between unicode code point from U+0080 to U+00FF will raise similar exception, since those non-ascii characters need explicit <code>0xc2</code> or <code>0xc3</code> prefix.</p>
<p>How can we get rid of this exception?</p>
<pre class="sourceCode"><code class="sourceCode haskell">&gt; <span class="kw">module</span> <span class="dt">Main</span> <span class="kw">where</span><br />&gt; <br />&gt; <span class="kw">import</span> <span class="dt">Data.Word</span> (<span class="dt">Word8</span>)<br />&gt; <span class="kw">import</span> <span class="kw">qualified</span> <span class="dt">Data.ByteString</span> <span class="kw">as</span> <span class="dt">B</span><br />&gt; <span class="kw">import</span> <span class="kw">qualified</span> <span class="dt">Data.ByteString.Char8</span> <span class="kw">as</span> <span class="dt">C8</span><br />&gt; <span class="kw">import</span> <span class="kw">qualified</span> <span class="dt">Data.ByteString.UTF8</span> <span class="kw">as</span> <span class="dt">U8</span><br />&gt; <span class="kw">import</span> <span class="kw">qualified</span> <span class="dt">Data.Text</span> <span class="kw">as</span> <span class="dt">T</span><br />&gt; <span class="kw">import</span> <span class="kw">qualified</span> <span class="dt">Data.Text.IO</span> <span class="kw">as</span> <span class="dt">T</span><br />&gt; <span class="kw">import</span> <span class="kw">qualified</span> <span class="dt">Data.Text.Encoding</span> <span class="kw">as</span> <span class="dt">E</span></code></pre>
<p>Suppose that we have latin1 string:</p>
<pre class="sourceCode"><code class="sourceCode haskell">&gt; <span class="ot">latin1s </span><span class="ot">::</span> <span class="dt">String</span><br />&gt; latin1s <span class="fu">=</span> <span class="st">&quot;français&quot;</span></code></pre>
<p>Applying <code>decodeUtf8</code> to latin1 chars will raise exception, as shown in top of this writing.</p>
<pre class="sourceCode"><code class="sourceCode haskell">&gt; <span class="ot">printNG </span><span class="ot">::</span> <span class="dt">String</span> <span class="ot">-&gt;</span> <span class="dt">IO</span> ()<br />&gt; printNG ss <span class="fu">=</span> T.putStrLn <span class="fu">$</span> E.decodeUtf8 <span class="fu">$</span> C8.pack ss</code></pre>
<p>Results in:</p>
<pre><code>| *Main&gt; ptintNG latin1s
| &quot;*** Exception: Cannot decode byte '\x61': Data.Text.Encoding.decodeUtf8: Invalid UTF-8 stream
</code></pre>
<p>The problem in this case was that <code>ByteString</code> representation of <code>ç</code> is expressed with single byte, instead of 2 bytes.</p>
<p>When the characters we matter are ascii and latin1 only, simple solution is to pad the prefix.</p>
<pre class="sourceCode"><code class="sourceCode haskell">&gt; <span class="ot">padLatin1s </span><span class="ot">::</span> <span class="dt">C8.ByteString</span> <span class="ot">-&gt;</span> <span class="dt">T.Text</span><br />&gt; padLatin1s <span class="fu">=</span> E.decodeUtf8 <span class="fu">.</span> C8.foldr f C8.empty <span class="kw">where</span><br />&gt;   f c a <span class="fu">|</span> <span class="ch">'\128'</span> <span class="fu">&lt;=</span> c <span class="fu">&amp;&amp;</span> c <span class="fu">&lt;</span> <span class="ch">'\192'</span> <span class="fu">=</span> C8.cons <span class="ch">'\194'</span> <span class="fu">.</span> C8.cons c <span class="fu">$</span> a<br />&gt;         <span class="fu">|</span> <span class="ch">'\192'</span> <span class="fu">&lt;=</span> c <span class="fu">&amp;&amp;</span> c <span class="fu">&lt;</span> <span class="ch">'\256'</span> <span class="fu">=</span><br />&gt;           C8.cons <span class="ch">'\195'</span> <span class="fu">.</span> C8.cons (<span class="fu">toEnum</span> (<span class="fu">fromEnum</span> c <span class="fu">-</span> <span class="dv">0x40</span>)) <span class="fu">$</span> a<br />&gt;         <span class="fu">|</span> <span class="fu">otherwise</span> <span class="fu">=</span> C8.cons c a</code></pre>
<p>Now we can decode bytestring data to Text data without exception.</p>
<pre class="sourceCode"><code class="sourceCode haskell">&gt; <span class="ot">printPadded </span><span class="ot">::</span> <span class="dt">String</span> <span class="ot">-&gt;</span> <span class="dt">IO</span> ()<br />&gt; printPadded ss <span class="fu">=</span> T.putStrLn <span class="fu">$</span> padLatin1s <span class="fu">$</span> C8.pack ss</code></pre>
<p>Results in:</p>
<pre><code>| *Main&gt; printPadded latin1s
| français
</code></pre>
<p>Though above padding approach does not work when documents has mixed use of characters between U+0080 and U+00FF with non-ascii, non-latin1 characters, since its always padded. Though it may useful when converting a limited set of character, which could expressed with sequence of hex numbers from <code>0x00</code> to <code>0xff</code>. Those inputs using hex numbers above <code>0xff</code> are not representable with <code>Data.ByteString</code>.</p>
<pre class="sourceCode"><code class="sourceCode haskell">&gt; <span class="ot">zhongwen </span><span class="ot">::</span> <span class="dt">String</span><br />&gt; zhongwen <span class="fu">=</span> <span class="st">&quot;中文&quot;</span></code></pre>
<p>Padding does not make sense:</p>
<pre><code>| *Main&gt; printPadded zhongwen
| -
</code></pre>
<p>Which function made the change? When we use <code>pack</code> from <code>Data.ByteString.Char8</code> to convert this String to ByteString, it results in:</p>
<pre><code>| *Main&gt; C8.pack zhongwen
| &quot;-\135&quot;
</code></pre>
<p>Which is not what we want in most cases.</p>
<p>Using pack from <code>Data.ByteString.Char8</code> will truncate hex number used for the characters, we get a value which could be expressed in <code>Word8</code> only.</p>
<p>Representing with ByteString is possible, however. It needs a longer, proper sequence of hex numbers.</p>
<pre class="sourceCode"><code class="sourceCode haskell">&gt; <span class="ot">zhongwen' </span><span class="ot">::</span> [<span class="dt">Word8</span>]<br />&gt; zhongwen' <span class="fu">=</span> [<span class="dv">0xe4</span>, <span class="dv">0xb8</span>, <span class="dv">0xad</span>, <span class="dv">0xe6</span>, <span class="dv">0x96</span>, <span class="dv">0x87</span>]</code></pre>
<p>We use Data.ByteString.pack to convert list of hex numbers:</p>
<pre class="sourceCode"><code class="sourceCode haskell">&gt; <span class="ot">printZhongwen </span><span class="ot">::</span> <span class="dt">IO</span> ()<br />&gt; printZhongwen <span class="fu">=</span> T.putStrLn <span class="fu">$</span> E.decodeUtf8 <span class="fu">$</span> B.pack zhongwen'</code></pre>
<p>Shows:</p>
<pre><code>| *Main&gt; printZhongwen
| 中文
</code></pre>
<p>So what we want here is a utf–8 aware function that converts list of <code>Char</code> to <code>ByteString</code>. A package <a href="http://hackage.haskell.org/package/utf8-string-0.3">utf8-string</a> has a converting function from <code>String</code> to <code>ByteString</code>.</p>
<pre class="sourceCode"><code class="sourceCode haskell">&gt; <span class="ot">printUTF8 </span><span class="ot">::</span> <span class="dt">String</span> <span class="ot">-&gt;</span> <span class="dt">IO</span> ()<br />&gt; printUTF8 ss <span class="fu">=</span> T.putStrLn <span class="fu">$</span> E.decodeUtf8 <span class="fu">$</span> U8.fromString ss</code></pre>
<p>Results:</p>
<pre><code>| *Main&gt; printUTF8 latin1s
| français
| *Main&gt; printUTF8 zhongwen
| 中文
</code></pre>
<p>There should be a situation with more complicated character encoding issues. To get more support of unicode, using <a href="http://hackage.haskell.org/package/text-icu">text-icu</a> should be better, as suggested in haddock comment of <a href="http://hackage.haskell.org/package/text">text</a>.</p>
</div>

<div class="post_tags">
  <strong>Tags: </strong><a href="../tags/haskell.html">haskell</a>, <a href="../tags/utf-8.html">utf-8</a>, <a href="../tags/web.html">web</a>
</div>


      </div>
      <div id="footer">
        <div id="footer_content">
          <p>
            <a href="../index.html">Home</a> |
            <a href="../archive.html">Archive</a> |
            <a href="../rss.xml">RSS</a>
          </p>

          Site contents licensed under
          <a href="http://creativecommons.org/licenses/by/3.0/">
            CC Attribution 3.0
          </a>
        </div>
      </div>
    </div>
  </body>
</html>
